<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ICANJ Church Calendar</title>

<!-- PapaParse for CSV parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --blue: #2879b8;
    --blue-dark: #1f6399;
    --bg: #efefef;
    --card: #ffffff;
    --muted: #9aa6b2;
    --accent: #ffd54f;
  }

  html,body{height:100%;margin:0;font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; display:flex; align-items:center; justify-content:center; background:var(--bg);}
  body{color:#24313a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}

  /* Container to mimic phone-style card */
  .wrap{ width:100%; max-width:720px; margin:auto; box-shadow:0 6px 20px rgba(0,0,0,0.12); border-radius:6px; overflow:hidden; background:var(--card); }

  /* Top ICANJ strip */
  .title-strip{
    background: var(--blue-dark);
    color:white;
    font-weight:600;
    font-size:1.25rem;
    text-align:center;
    padding:12px;
  }

  /* Top blue calendar area */
  .top {
    background: linear-gradient(180deg,var(--blue),var(--blue-dark));
    color:white;
    padding:12px;
  }

  .top-bar{ display:flex; align-items:center; justify-content:center; gap:8px; }
  .nav-row{ display:flex; align-items:center; justify-content:center; margin-top:8px; color:rgba(255,255,255,0.9); gap:8px; }
  .nav-arrows{ display:flex; gap:8px; align-items:center; }
  select{ padding:4px 6px; border-radius:4px; border:none; font-weight:600; }

  /* Weekday labels */
  .weekday-row{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:10px; color:rgba(255,255,255,0.85); font-size:0.78rem; text-align:center; padding:0 6px; }
  .weekday{ opacity:0.9; padding:8px 6px; }

  /* Calendar grid area inside blue card */
  .calendar-grid {
    display:grid;
    grid-template-columns: repeat(7, 1fr);
    gap:8px;
    padding:10px;
  }

  .day {
    background: transparent;
    min-height:50px;
    border-radius:6px;
    color:rgba(255,255,255,0.95);
    position:relative;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    padding-top:6px;
    font-size:0.95rem;
    cursor:pointer;
  }

  .day.disabled{ opacity:0.25; cursor:default; }

  .day .dot {
    width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    background: rgba(255,255,255,0.12);
    transition: all .12s ease;
    font-weight:600;
  }
  .day.selected .dot {
    background: rgba(255,255,255,0.18);
    box-shadow: 0 0 0 10px rgba(255,255,255,0.03) inset;
  }

  .event-dot {
    width:8px;height:8px;border-radius:50%;background:var(--accent); margin-top:6px; box-shadow:0 1px 0 rgba(0,0,0,0.08);
  }

  .fab {
    position:absolute; right:18px; bottom:96px; width:52px; height:52px; border-radius:50%;
    background:#222; color:white; display:grid; place-items:center; box-shadow:0 8px 18px rgba(0,0,0,0.25); z-index:60; cursor:pointer;
  }

  .events-panel {
    background:var(--card);
    border-top-left-radius:10px;
    border-top-right-radius:10px;
    padding:12px 14px;
    max-height:320px;
    overflow:auto;
  }
  .panel-date { font-weight:600; margin-bottom:6px; color:#22313a; }
  .no-events { text-align:center; color:var(--muted); padding:22px 6px; font-style:italic; }

  .event-item {
    display:flex; gap:10px; align-items:flex-start; padding:12px 6px; border-bottom:1px solid #f0f3f5;
  }
  .event-icon { width:44px; height:44px; border-radius:8px; background:var(--blue); color:white; display:grid; place-items:center; font-weight:700; font-size:1rem; margin-top:2px; }
  .event-body { flex:1; }
  .event-title { font-weight:600; color:#22313a; }
  .event-meta { color:var(--muted); font-size:0.9rem; margin-top:4px; }

  /* Remove tooltip entirely (hover effect discarded) */

  /* small screens adjustments */
  @media (max-width:420px) {
    .wrap{ margin:10px; }
    .fab{ right:14px; bottom:120px; }
    .calendar-grid{ padding:8px; gap:6px; }
    .weekday-row{ padding:0 8px; }
  }

</style>
</head>
<body>

<div class="wrap" id="app">
  <!-- Title strip -->
  <div class="title-strip">ICANJ Church Calendar</div>

  <!-- TOP BLUE AREA -->
  <div class="top">
    <div class="top-bar">
      <!-- Month & Year selectors -->
      <select id="monthSelect"></select>
      <select id="yearSelect"></select>
    </div>

    <div class="weekday-row" aria-hidden="true">
      <div class="weekday">Mon</div>
      <div class="weekday">Tue</div>
      <div class="weekday">Wed</div>
      <div class="weekday">Thu</div>
      <div class="weekday">Fri</div>
      <div class="weekday">Sat</div>
      <div class="weekday">Sun</div>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>
  </div>

  <!-- FAB add button -->
  <div class="fab" id="fab" title="Add event">+</div>

  <!-- Events panel -->
  <div class="events-panel">
    <div class="panel-date" id="panelDate">Select a date</div>
    <div id="panelList" class="panel-scroll">
      <div class="no-events">No events selected. Tap a day to view details.</div>
    </div>
  </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8HNWc5Lj5FPBV3vJfpUa3S4_W2h4O32e6W6uxqhamh4riojoSqtCnBpTrPabaln0esefo3ixCbp-v/pub?output=csv";
let events = [];
let currentDate = new Date();
let selectedDateStr = null;

const monthMap = { "January":1,"February":2,"March":3,"April":4,"May":5,"June":6,"July":7,"August":8,"September":9,"October":10,"November":11,"December":12 };

function pad(n){ return String(n).padStart(2,'0'); }
function toYMD(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function parseSheetDate(cell){
  if(!cell) return null;
  let s = cell.trim();
  const parts = s.split(',');
  if(parts.length>1){
    const datePart = parts.slice(1).join(',').trim();
    const cleaned = datePart.replace(/,/g,'').trim();
    const bits = cleaned.split(/\s+/);
    if(bits.length>=3){
      const month = monthMap[bits[0]];
      const day = parseInt(bits[1].replace(/\D/g,''),10);
      const year = parseInt(bits[2],10);
      if(month && day && year) return `${year}-${pad(month)}-${pad(day)}`;
    }
  } else {
    const d = new Date(s);
    if(!isNaN(d)) return toYMD(d);
  }
  return null;
}

async function loadCsvAndParse(){
  try{
    const res = await fetch(CSV_URL);
    const text = await res.text();
    Papa.parse(text, {
      skipEmptyLines:true,
      complete: function(results){
        const data = results.data;
        let headerRowIndex = data.findIndex(r => r.some(cell => (cell||'').toString().toUpperCase().includes("DATE")));
        if(headerRowIndex < 0) headerRowIndex = 0;
        const rawHeaders = data[headerRowIndex].map(h => (h||'').toString().trim().toUpperCase());
        const rows = data.slice(headerRowIndex+1);

        const mapped = rows.map(row=>{
          const obj = {};
          rawHeaders.forEach((h,i)=> obj[h] = (row[i]||'').toString().trim() );
          const parsed = parseSheetDate(obj['DATE'] || obj['DATE ']);
          if(parsed) obj.parsedDate = parsed;
          return obj;
        }).filter(o => o.parsedDate);

        events = mapped;
        document.getElementById('panelDate').textContent = `${events.length} events loaded`;
        populateMonthYearSelectors();
        renderCalendar();
      }
    });
  } catch(err){
    console.error("CSV load error:", err);
    document.getElementById('panelList').innerHTML = '<div class="no-events">Error loading sheet.</div>';
  }
}

function renderCalendar(){
  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const firstOfMonth = new Date(year, month, 1);
  const weekdayOfFirst = (firstOfMonth.getDay() + 6) % 7;
  const totalDays = new Date(year, month+1, 0).getDate();

  for(let i=0;i<weekdayOfFirst;i++){
    const empty = document.createElement('div');
    empty.className = 'day disabled';
    grid.appendChild(empty);
  }

  for(let d=1; d<=totalDays; d++){
    const dt = new Date(year, month, d);
    const ymd = toYMD(dt);
    const dayEl = document.createElement('div');
    dayEl.className = 'day';
    dayEl.dataset.ymd = ymd;

    const dot = document.createElement('div');
    dot.className = 'dot';
    dot.textContent = d;
    dayEl.appendChild(dot);

    const dayEvents = events.filter(e => e.parsedDate === ymd && e.PROGRAM);
    if(dayEvents.length>0){
      const evDot = document.createElement('div');
      evDot.className = 'event-dot';
      dayEl.appendChild(evDot);
    }

    if(selectedDateStr === ymd){
      dayEl.classList.add('selected');
    }

    dayEl.addEventListener('click', (e) => {
      e.stopPropagation();
      selectedDateStr = ymd;
      populatePanelForDate(ymd);
      document.querySelectorAll('.day.selected').forEach(el=>el.classList.remove('selected'));
      dayEl.classList.add('selected');
    });

    grid.appendChild(dayEl);
  }
}

function populatePanelForDate(ymd){
  const panelDate = document.getElementById('panelDate');
  const panelList = document.getElementById('panelList');
  const d = new Date(ymd);
  const readable = d.toLocaleString('default',{day:'numeric', month:'long', year:'numeric'});
  panelDate.textContent = readable;

  const dayEvents = events.filter(e => e.parsedDate === ymd);
  if(dayEvents.length === 0){
    panelList.innerHTML = `<div class="no-events">No events planned for today</div>`;
    return;
  }

  panelList.innerHTML = '';
  dayEvents.forEach(ev => {
    const item = document.createElement('div');
    item.className = 'event-item';
    const icon = document.createElement('div');
    icon.className = 'event-icon';
    const initials = (ev.PROGRAM || 'Event').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
    icon.textContent = initials;
    const body = document.createElement('div');
    body.className = 'event-body';
    const title = document.createElement('div');
    title.className = 'event-title';
    title.textContent = ev.PROGRAM || 'Untitled event';
    const meta = document.createElement('div');
    meta.className = 'event-meta';
    meta.innerHTML = (ev.LOCATION?`📍 ${escapeHtml(ev.LOCATION)} `:'') + (ev.CONTACT?` • ☎ ${escapeHtml(ev.CONTACT)}`:'') + (ev.COMMENTS?`<div style="margin-top:6px;color:var(--muted)">${escapeHtml(ev.COMMENTS)}</div>`:'');
    body.appendChild(title);
    body.appendChild(meta);
    item.appendChild(icon);
    item.appendChild(body);
    panelList.appendChild(item);
  });
}

/* -------------------------
   Month-Year selectors
--------------------------*/
function populateMonthYearSelectors(){
  const monthSel = document.getElementById('monthSelect');
  const yearSel = document.getElementById('yearSelect');
  const months = Object.keys(monthMap);
  monthSel.innerHTML = months.map((m,i)=> `<option value="${i}" ${i===currentDate.getMonth()?'selected':''}>${m}</option>`).join('');
  const yearRange = [];
  const currentYear = new Date().getFullYear();
  for(let y=currentYear-5; y<=currentYear+5; y++) yearRange.push(y);
  yearSel.innerHTML = yearRange.map(y=> `<option value="${y}" ${y===currentDate.getFullYear()?'selected':''}>${y}</option>`).join('');

  monthSel.addEventListener('change', ()=> {
    currentDate.setMonth(parseInt(monthSel.value));
    renderCalendar();
  });
  yearSel.addEventListener('change', ()=> {
    currentDate.setFullYear(parseInt(yearSel.value));
    renderCalendar();
  });
}

/* -------------------------
   Init
--------------------------*/
document.getElementById('fab').addEventListener('click', ()=>alert('Add event action (UI only in this demo).'));
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"]/g, function(c){ return { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;' }[c]; }); }

loadCsvAndParse();
renderCalendar();
</script>
</body>
</html>
