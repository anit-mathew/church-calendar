<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Church Calendar</title>
<style>
  body { font-family: system-ui, "Segoe UI", Roboto, Arial, sans-serif; background: #f5f6fa; margin: 0; padding: 20px; color: #2d3748; }
  h1 { text-align: center; color: #2b6cb0; margin-bottom: 10px; }
  #status { text-align: center; margin-bottom: 10px; font-weight: bold; }
  #calendar-nav { text-align: center; margin-bottom: 10px; }
  #calendar-nav button { background: #2b6cb0; color: #fff; border: none; padding: 8px 15px; margin: 0 5px; border-radius: 5px; cursor: pointer; }
  #calendar-nav span { font-weight: bold; margin: 0 10px; }
  #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; max-width: 1000px; margin: 0 auto; }
  .day { background: #fff; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); padding: 10px; min-height: 80px; position: relative; cursor: pointer; transition: transform 0.2s; }
  .day:hover { transform: translateY(-2px); }
  .date-num { font-weight: bold; margin-bottom: 4px; display: block; }
  .event-name { font-size: 0.9rem; color: #2b6cb0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tooltip { display: none; position: absolute; top: 100%; left: 10px; background: #2b6cb0; color: #fff; padding: 8px; border-radius: 6px; font-size: 0.8rem; z-index: 10; width: max-content; max-width: 200px; }
  .day:hover .tooltip { display: block; }
</style>
</head>
<body>
<h1>Church Calendar</h1>
<div id="status">Loading data...</div>
<div id="calendar-nav">
  <button id="prev-month">&lt; Prev</button>
  <span id="month-year"></span>
  <button id="next-month">Next &gt;</button>
</div>
<div id="calendar"></div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8HNWc5Lj5FPBV3vJfpUa3S4_W2h4O32e6W6uxqhamh4riojoSqtCnBpTrPabaln0esefo3ixCbp-v/pub?output=csv";
let events = [];
let currentDate = new Date();

async function fetchCsv(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("Failed to fetch CSV");
  return await res.text();
}

function parseCsv(text) {
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(",").map(h => h.trim());
  return lines.slice(1).map(line => {
    const cols = line.split(",").map(c => c.trim());
    const obj = {};
    headers.forEach((h,i) => obj[h] = cols[i] || '');
    if(obj.DATE){
      const d = new Date(obj.DATE);
      obj.parsedDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    return obj;
  });
}

function buildCalendar() {
  const calendar = document.getElementById("calendar");
  calendar.innerHTML = "";
  const month = currentDate.getMonth();
  const year = currentDate.getFullYear();
  document.getElementById("month-year").textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

  const firstDay = new Date(year, month, 1).getDay();
  const totalDays = new Date(year, month + 1, 0).getDate();

  for(let i=0;i<firstDay;i++){
    const empty = document.createElement("div");
    empty.className = "day";
    calendar.appendChild(empty);
  }

  for(let d=1; d<=totalDays; d++){
    const dayDiv = document.createElement("div");
    dayDiv.className = "day";
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

    const dateNum = document.createElement("span");
    dateNum.className = "date-num";
    dateNum.textContent = d;
    dayDiv.appendChild(dateNum);

    const ev = events.find(e => e.parsedDate === dateStr);
    if(ev){
      const name = document.createElement("span");
      name.className = "event-name";
      name.textContent = ev.PROGRAM || "";
      dayDiv.appendChild(name);

      const tooltip = document.createElement("div");
      tooltip.className = "tooltip";
      tooltip.innerHTML = `
        <strong>${ev.PROGRAM || ""}</strong><br>
        Location: ${ev.LOCATION || ""}<br>
        Contact: ${ev.CONTACT || ""}<br>
        Comments: ${ev.COMMENTS || ""}
      `;
      dayDiv.appendChild(tooltip);
    }

    calendar.appendChild(dayDiv);
  }
}

document.getElementById("prev-month").addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth()-1); buildCalendar(); });
document.getElementById("next-month").addEventListener("click", () => { currentDate.setMonth(currentDate.getMonth()+1); buildCalendar(); });

async function init() {
  const status = document.getElementById("status");
  try {
    const csv = await fetchCsv(CSV_URL);
    events = parseCsv(csv);
    if(events.length > 0){
      status.textContent = `Data loaded successfully! ${events.length} events found.`;
      status.style.color = "green";
    } else {
      status.textContent = "No events found in the sheet.";
      status.style.color = "orange";
    }
    buildCalendar();
  } catch(e){
    console.error(e);
    status.textContent = "Error loading data from Google Sheet!";
    status.style.color = "red";
    document.getElementById("calendar").textContent = "Cannot display calendar.";
  }
}

init();
</script>
</body>
</html>
