<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ICANJ Church Calendar 2026 </title>
<style>
  body {
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: #f5f6fa;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }

  .calendar-container {
    width: 440px;
    max-width: 95%;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
  }

  .header {
    background: #1976d2;
    color: #fff;
    padding: 16px;
    text-align: center;
    font-size: 1.4rem;
    font-weight: 600;
  }

  .nav {
    display: flex;
    justify-content: center;
    align-items: center;
    background: #2196f3;
    padding: 10px;
    gap: 10px;
  }

  select, button {
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 1rem;
    background: #fff;
    color: #333;
    cursor: pointer;
  }

  #calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    gap: 6px;
    padding: 16px;
  }

  .day-name {
    font-weight: 600;
    color: #1976d2;
    font-size: 0.9rem;
  }

  .day {
    width: 55px;
    height: 55px;
    margin: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    font-size: 0.95rem;
    color: #333;
    border-radius: 50%;
  }

  .day.event::after {
    content: "";
    position: absolute;
    bottom: 6px;
    width: 6px;
    height: 6px;
    background: #ff5252;
    border-radius: 50%;
  }

  .day.today {
    background: #1976d2;
    color: white;
  }

  .event-list {
    padding: 16px;
    border-top: 1px solid #eee;
    min-height: 100px;
  }

  .event-title {
    font-weight: bold;
    color: #1976d2;
  }

  .event-item {
    margin-top: 8px;
    font-size: 0.9rem;
    line-height: 1.3;
  }

  @media (max-width: 600px) {
    .calendar-container {
      width: 95%;
    }
    .day {
      width: 42px;
      height: 42px;
      font-size: 0.85rem;
    }
  }
</style>
</head>
<body>
<div class="calendar-container">
  <div class="header">ICANJ Church Calendar</div>

  <div class="nav">
    <button id="prevMonth">‚óÄ</button>
    <select id="monthSelect"></select>
    <select id="yearSelect"></select>
    <button id="nextMonth">‚ñ∂</button>
  </div>

  <div id="calendar"></div>
  <div class="event-list" id="eventList">
    <div class="event-title" id="eventTitle">No date selected</div>
    <div id="eventDetails">Select a date to see events</div>
  </div>
</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ8HNWc5Lj5FPBV3vJfpUa3S4_W2h4O32e6W6uxqhamh4riojoSqtCnBpTrPabaln0esefo3ixCbp-v/pub?output=csv";

let events = [];
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

// ‚úÖ Robust CSV parser
async function fetchCsv(url) {
  const res = await fetch(url);
  const text = await res.text();
  const rows = text.trim().split(/\r?\n/);
  const headers = rows[0].split(",").map((h) => h.trim());
  return rows.slice(1).map((row) => {
    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map((c) =>
      c.replace(/(^"|"$)/g, "").trim()
    );
    const obj = {};
    headers.forEach((h, i) => (obj[h] = cols[i]));
    return obj;
  });
}

// ‚úÖ Fix date parsing (handles ‚ÄúThursday, January 1, 2026‚Äù)
function parseDate(str) {
  if (!str) return null;
  let cleaned = str.replace(/^[A-Za-z]+,\s*/, "").trim(); // remove weekday
  const d = new Date(cleaned);
  return isNaN(d) ? null : d;
}

function renderCalendar() {
  const cal = document.getElementById("calendar");
  cal.innerHTML = "";

  const daysOfWeek = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
  daysOfWeek.forEach((d) => {
    const dn = document.createElement("div");
    dn.textContent = d;
    dn.className = "day-name";
    cal.appendChild(dn);
  });

  const firstDay = new Date(currentYear, currentMonth, 1);
  const startDay = (firstDay.getDay() + 6) % 7; // Monday start
  const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();

  for (let i = 0; i < startDay; i++) {
    const empty = document.createElement("div");
    cal.appendChild(empty);
  }

  for (let d = 1; d <= totalDays; d++) {
    const cell = document.createElement("div");
    cell.className = "day";
    const today = new Date();
    if (
      d === today.getDate() &&
      currentMonth === today.getMonth() &&
      currentYear === today.getFullYear()
    ) {
      cell.classList.add("today");
    }

    cell.textContent = d;

    const hasEvent = events.some((ev) => {
      const evDate = parseDate(ev.DATE);
      return (
        evDate &&
        evDate.getDate() === d &&
        evDate.getMonth() === currentMonth &&
        evDate.getFullYear() === currentYear &&
        ev.PROGRAM
      );
    });

    if (hasEvent) cell.classList.add("event");

    cell.addEventListener("click", () => showEventsForDate(d));
    cal.appendChild(cell);
  }
}

function showEventsForDate(day) {
  const list = document.getElementById("eventDetails");
  const title = document.getElementById("eventTitle");
  const dateObj = new Date(currentYear, currentMonth, day);
  title.textContent = dateObj.toDateString();

  const evs = events.filter((ev) => {
    const evDate = parseDate(ev.DATE);
    return (
      evDate &&
      evDate.getDate() === day &&
      evDate.getMonth() === currentMonth &&
      evDate.getFullYear() === currentYear &&
      ev.PROGRAM
    );
  });

  if (evs.length === 0) {
    list.innerHTML = "<i>No events planned for this day</i>";
  } else {
    list.innerHTML = evs
      .map(
        (ev) => `
      <div class="event-item">
        <strong>${ev.PROGRAM}</strong><br>
        ${ev.LOCATION ? "üìç " + ev.LOCATION + "<br>" : ""}
        ${ev.CONTACT ? "‚òé " + ev.CONTACT + "<br>" : ""}
        ${ev.COMMENTS ? "üí¨ " + ev.COMMENTS : ""}
      </div>
    `
      )
      .join("");
  }
}

function populateSelectors() {
  const monthSelect = document.getElementById("monthSelect");
  const yearSelect = document.getElementById("yearSelect");
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  monthSelect.innerHTML = "";
  yearSelect.innerHTML = "";

  monthNames.forEach((m, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = m;
    if (i === currentMonth) opt.selected = true;
    monthSelect.appendChild(opt);
  });

  for (let y = 2025; y <= 2030; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    if (y === currentYear) opt.selected = true;
    yearSelect.appendChild(opt);
  }

  monthSelect.addEventListener("change", () => {
    currentMonth = parseInt(monthSelect.value);
    renderCalendar();
  });

  yearSelect.addEventListener("change", () => {
    currentYear = parseInt(yearSelect.value);
    renderCalendar();
  });

  document.getElementById("prevMonth").addEventListener("click", () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    renderCalendar();
  });

  document.getElementById("nextMonth").addEventListener("click", () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    monthSelect.value = currentMonth;
    yearSelect.value = currentYear;
    renderCalendar();
  });
}

async function init() {
  try {
    const data = await fetchCsv(CSV_URL);
    events = data.filter((e) => e.DATE && e.PROGRAM);
    console.log(`‚úÖ Loaded ${events.length} events`);
    populateSelectors();
    renderCalendar();
  } catch (err) {
    console.error("‚ùå Error loading calendar data:", err);
    document.getElementById("calendar").textContent = "Error loading data.";
  }
}

init();
</script>
</body>
</html>
