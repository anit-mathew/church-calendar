<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ICANJ Church Calendar</title>

<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>

:root{
  --blue: #2879b8;
  --blue-dark: #1f6399;
  --bg: #efefef;
  --card: #ffffff;
  --muted: #9aa6b2;
  --accent: #ffd54f;
}

html,body{
  height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI";
  display:flex;align-items:center;justify-content:center;background:var(--bg);
}
.wrap{width:100%;max-width:720px;margin:auto;box-shadow:0 6px 20px rgba(0,0,0,0.12);
  border-radius:6px;overflow:hidden;background:var(--card);}
.title-strip{background:var(--blue-dark);color:white;font-weight:600;
  font-size:1.25rem;text-align:center;padding:12px;}

.top{background:linear-gradient(180deg,var(--blue),var(--blue-dark));color:white;padding:12px;}

.top-bar{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px;}
select{padding:4px 6px;border-radius:4px;border:none;font-weight:600;}
button{background:transparent;border:none;color:white;font-weight:bold;cursor:pointer;font-size:1.2rem;}

.weekday-row{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;
  color:rgba(255,255,255,0.85);font-size:0.78rem;text-align:center;padding:0 6px;}

.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:10px;height:420px;}

.day{background:transparent;min-height:50px;border-radius:6px;color:rgba(255,255,255,0.95);
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  padding-top:6px;font-size:0.95rem;cursor:pointer;}
.day.disabled{opacity:0.25;cursor:default;}

.day .dot{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;background:rgba(255,255,255,0.12);font-weight:600;}
.day.selected .dot{background:rgba(255,255,255,0.18);box-shadow:0 0 0 10px rgba(255,255,255,0.03) inset;}

.event-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);margin-top:2px;}

.fab{position:absolute;right:18px;bottom:96px;width:52px;height:52px;border-radius:50%;
  background:#222;color:white;display:grid;place-items:center;box-shadow:0 8px 18px rgba(0,0,0,0.25);cursor:pointer;}

.events-panel{
  background:var(--card);
  border-top-left-radius:10px;
  border-top-right-radius:10px;
  padding:12px 14px;

  /* FIXED HEIGHT */
  height:320px;           
  max-height:320px;

  /* SCROLL INSIDE, NOT OUTSIDE */
  overflow-y:auto;
  overflow-x:hidden;
}
  
.panel-date{font-weight:600;margin-bottom:6px;color:#22313a;}
.no-events{text-align:center;color:var(--muted);padding:22px 6px;font-style:italic;}

.event-item{display:flex;gap:10px;padding:12px 6px;border-bottom:1px solid #f0f3f5;}
.event-icon{width:44px;height:44px;border-radius:8px;background:var(--blue);
  color:white;display:grid;place-items:center;font-weight:700;}
.event-title{font-weight:600;}
</style>
</head>

<body>

<div class="wrap" id="app">
  <div class="title-strip">ICANJ Church Calendar</div>

  <div class="top">
    <div class="top-bar">
      <button id="prevMonthBtn">&#8592;</button>
      <select id="monthSelect"></select>
      <select id="yearSelect"></select>
      <button id="nextMonthBtn">&#8594;</button>
    </div>

    <!-- SUNDAY FIRST -->
    <div class="weekday-row">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
      <div>Thu</div><div>Fri</div><div>Sat</div>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
  
<div style="text-align:center; padding:10px;">
  <button id="fullMonthBtn" style="
    padding:8px 12px;
    background:#222;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
  ">
    Full Month View ON
  </button>
</div>
  <div class="events-panel">
    <div class="panel-date" id="panelDate">Select a date</div>
    <div id="panelList">
      <div class="no-events">No events selected. Tap a day.</div>
    </div>
  </div>
</div>

<script>
const CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vTsF_4-QMue4gC-b8i13mBH_7uFpLjmvK6Zs0-jS1mJcR6V-_EN-mz-WF44x8xlqP_XzZgoOx_y9JE6/pub?gid=1852846165&single=true&output=csv";

let events = [];
let currentDate = new Date();
let selectedDateStr = null;

function pad(n){ return String(n).padStart(2,'0'); }
function toYMD(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

function escapeHtml(s){
  if(!s) return '';
  return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}

/* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
   Fix timezone: parse date in local time always
‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
function parseLocalDate(str){
  const d = new Date(str);
  if (isNaN(d)) return null;

  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function normalizeDate(dateStr){
  if(!dateStr) return null;

  const d = parseLocalDate(dateStr);
  if(d) return toYMD(d);

  return null;
}
let fullMonthOn = false;

document.getElementById("fullMonthBtn").onclick = () => {
  fullMonthOn = !fullMonthOn;
  const btn = document.getElementById("fullMonthBtn");

  if (fullMonthOn) {
    btn.textContent = "Full Month View OFF";
    showFullMonthEvents();
  } else {
    btn.textContent = "Full Month View ON";
    if (selectedDateStr) {
      populatePanelForDate(selectedDateStr);
    } else {
      document.getElementById("panelList").innerHTML =
        `<div class="no-events">No events selected. Tap a day.</div>`;
      document.getElementById("panelDate").textContent = "Select a date";
    }
  }
};
  
async function loadCsvAndParse(){
  try{
    const res = await fetch(CSV_URL);
    const text = await res.text();

    Papa.parse(text, {
      skipEmptyLines:true,
      complete: result => {
        const data = result.data;

        let headerRowIndex = data.findIndex(r =>
          r.some(c => (c||"").toUpperCase().includes("DATE"))
        );

        if(headerRowIndex < 0) headerRowIndex = 0;

        const headers = data[headerRowIndex].map(h => (h||"").trim().toUpperCase());
        const rows = data.slice(headerRowIndex+1);

        events = [];

        rows.forEach(row=>{
          const obj = {};
          headers.forEach((h,i)=> obj[h] = (row[i]||"").trim() );

          const normalizedDate = normalizeDate(obj["DATE"]);

          if(normalizedDate){
            const programs = obj.PROGRAM ? obj.PROGRAM.split("|") : [''];
            const locations = obj.LOCATION ? obj.LOCATION.split("|") : [''];
            const contacts = obj.CONTACT ? obj.CONTACT.split("|") : [''];
            const comments = obj.COMMENTS ? obj.COMMENTS.split("|") : [''];
            const visibilities = obj.VISIBILITY ? obj.VISIBILITY.split("|") : [''];

            const maxLen = Math.max(programs.length, locations.length, contacts.length, comments.length, visibilities.length);

            for(let i=0;i<maxLen;i++){
              events.push({
                parsedDate: normalizedDate,
                PROGRAM: programs[i] || '',
                LOCATION: locations[i] || '',
                CONTACT: contacts[i] || '',
                COMMENTS: comments[i] || '',
                VISIBILITY: visibilities[i] || 'Public'
              });
            }
          }
        });

        renderCalendar();
      }
    });

  } catch(e){
    console.error("CSV load error:", e);
  }
}

function renderCalendar(){
  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";

  const y = currentDate.getFullYear();
  const m = currentDate.getMonth();
  const first = new Date(y, m, 1);

  /* SUNDAY FIRST ‚Äî offset Monday=1 ‚Üí Sunday=0 */
  const wd = first.getDay();  // 0=Sun, 1=Mon‚Ä¶

  const total = new Date(y, m+1, 0).getDate();

  for(let i=0;i<wd;i++){
    const e = document.createElement("div");
    e.className="day disabled";
    grid.appendChild(e);
  }

  for(let d=1; d<=total; d++){
    const dt = new Date(y, m, d);
    const ymd = toYMD(dt);

    const dayEl = document.createElement("div");
    dayEl.className="day";
    dayEl.dataset.ymd = ymd;

    const dot = document.createElement("div");
    dot.className="dot";
    dot.textContent = d;
    dayEl.appendChild(dot);

    const dayEvents = events.filter(e =>
      e.parsedDate === ymd &&
      (!e.VISIBILITY || e.VISIBILITY.toLowerCase().includes("public")) &&
      e.PROGRAM.trim() !== ""
    );

    if(dayEvents.length > 0){
      const evDot = document.createElement("div");
      evDot.className="event-dot";
      dayEl.appendChild(evDot);
    }

    if(selectedDateStr === ymd) dayEl.classList.add("selected");

    dayEl.onclick = () => {
      selectedDateStr = ymd;
      populatePanelForDate(ymd);
      document.querySelectorAll(".day.selected").forEach(el=>el.classList.remove("selected"));
      dayEl.classList.add("selected");
    };

    grid.appendChild(dayEl);
  }
}

function populatePanelForDate(ymd){
  const panelDate = document.getElementById("panelDate");
  const panelList = document.getElementById("panelList");

const parts = ymd.split("-");
const d = new Date(parts[0], parts[1]-1, parts[2]); // Local date
panelDate.textContent = d.toLocaleString("default",{day:"numeric",month:"long",year:"numeric"});

  const dayEvents = events.filter(e =>
    e.parsedDate === ymd &&
    (!e.VISIBILITY || e.VISIBILITY.toLowerCase().includes("public")) &&
    e.PROGRAM.trim() !== ""
  );

  if(dayEvents.length === 0){
    panelList.innerHTML = `<div class="no-events">No events planned for today</div>`;
    return;
  }

  panelList.innerHTML = "";

  dayEvents.forEach(ev=>{
    const item = document.createElement("div");
    item.className="event-item";

    const icon = document.createElement("div");
    icon.className="event-icon";
    icon.textContent = ev.PROGRAM.split(" ").map(x=>x[0]).join("").substring(0,2).toUpperCase();

    const body = document.createElement("div");
    const title = document.createElement("div");
    title.className="event-title";
    title.textContent = ev.PROGRAM;

    const meta = document.createElement("div");
    meta.innerHTML =
      (ev.LOCATION?`üìç ${escapeHtml(ev.LOCATION)}<br>`:"") +
      (ev.CONTACT?` ‚òé  ${escapeHtml(ev.CONTACT)}<br>`:"") +
      (ev.COMMENTS ? ` üí¨ <span style="color:#9aa6b2;"> ${escapeHtml(ev.COMMENTS)}</span>` : "");

    body.appendChild(title);
    body.appendChild(meta);
    item.appendChild(icon);
    item.appendChild(body);
    panelList.appendChild(item);
  });
}

function initMonthYearSelectors(){
  const monthSel = document.getElementById("monthSelect");
  const yearSel = document.getElementById("yearSelect");

  const months = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];

  months.forEach((m,i)=>{
    const o=document.createElement("option");
    o.value=i; o.textContent=m;
    monthSel.appendChild(o);
  });

  const yr = currentDate.getFullYear();
  for(let y=yr-5; y<=yr+20; y++){
    const o=document.createElement("option");
    o.value=y; o.textContent=y;
    yearSel.appendChild(o);
  }

  monthSel.value = currentDate.getMonth();
  yearSel.value = currentDate.getFullYear();

  monthSel.onchange = ()=>{
    currentDate.setMonth(parseInt(monthSel.value));
    renderCalendar();
  };

  yearSel.onchange = ()=>{
    currentDate.setFullYear(parseInt(yearSel.value));
    renderCalendar();
  };
}

document.getElementById("prevMonthBtn").onclick = ()=>{
  currentDate.setMonth(currentDate.getMonth()-1);
  initMonthYearSelectors();
  renderCalendar();
};

document.getElementById("nextMonthBtn").onclick = ()=>{
  currentDate.setMonth(currentDate.getMonth()+1);
  initMonthYearSelectors();
  renderCalendar();
};
function showFullMonthEvents() {
  const panelDate = document.getElementById("panelDate");
  const panelList = document.getElementById("panelList");

  const y = currentDate.getFullYear();
  const m = currentDate.getMonth() + 1;

  panelDate.textContent = 
    `All Public Events ‚Äì ${currentDate.toLocaleString("default",{month:"long"})} ${y}`;

  const monthStr = `${y}-${String(m).padStart(2,"0")}`;

  const monthEvents = events.filter(ev =>
    ev.parsedDate.startsWith(monthStr) &&
    (!ev.VISIBILITY || ev.VISIBILITY.toLowerCase().includes("public")) &&
    ev.PROGRAM.trim() !== ""
  );

  if (monthEvents.length === 0) {
    panelList.innerHTML = `<div class="no-events">No public events for this month.</div>`;
    return;
  }

  panelList.innerHTML = "";

  monthEvents.forEach(ev => {
    const item = document.createElement("div");
    item.className = "event-item";

    const icon = document.createElement("div");
    icon.className = "event-icon";
    icon.textContent = ev.PROGRAM.split(" ").map(x=>x[0]).join("").substring(0,2).toUpperCase();

    const body = document.createElement("div");

    const title = document.createElement("div");
    title.className = "event-title";

    // ‚≠ê ADD DATE DISPLAY ‚≠ê
    const parts = ev.parsedDate.split("-");
    const localDate = new Date(parts[0], parts[1]-1, parts[2]);
    const formattedDate = localDate.toLocaleString("default", {
      month: "short",
      day: "numeric"
    });

    title.textContent = `${formattedDate} ‚Äì ${ev.PROGRAM}`;

    const meta = document.createElement("div");
    meta.innerHTML =
      (ev.LOCATION ? `üìç ${escapeHtml(ev.LOCATION)}<br>` : "") +
      (ev.CONTACT ? ` ‚òé ${escapeHtml(ev.CONTACT)}<br>` : "") +
      (ev.COMMENTS ? ` üí¨ <span style="color:#9aa6b2;">${escapeHtml(ev.COMMENTS)}</span>` : "");

    body.appendChild(title);
    body.appendChild(meta);

    item.appendChild(icon);
    item.appendChild(body);

    panelList.appendChild(item);
  });
}

loadCsvAndParse();
initMonthYearSelectors();
renderCalendar();
</script>

</body>
</html>
